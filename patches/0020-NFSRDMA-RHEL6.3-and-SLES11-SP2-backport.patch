From b824c830e756c1466a7a84109b9954d2772586b9 Mon Sep 17 00:00:00 2001
From: Jeff Becker <jeffrey.c.becker@nasa.gov>
Date: Fri, 24 Aug 2012 11:18:23 -0700
Subject: [PATCH 20/25] NFSRDMA: RHEL6.3 and SLES11 SP2 backport

Signed-off-by: Jeff Becker <Jeffrey.C.Becker@nasa.gov>
---
 net/sunrpc/xprtrdma/rpc_rdma.c           |   16 ++++++++++++++++
 net/sunrpc/xprtrdma/svc_rdma_transport.c |    4 ++++
 net/sunrpc/xprtrdma/transport.c          |   12 ++++++++++++
 3 files changed, 32 insertions(+)

diff --git a/net/sunrpc/xprtrdma/rpc_rdma.c b/net/sunrpc/xprtrdma/rpc_rdma.c
index 558fbab..0a6c1db 100644
--- a/net/sunrpc/xprtrdma/rpc_rdma.c
+++ b/net/sunrpc/xprtrdma/rpc_rdma.c
@@ -338,9 +338,17 @@ rpcrdma_inline_pullup(struct rpc_rqst *rqst, int pad)
 			curlen = copy_len;
 		dprintk("RPC:       %s: page %d destp 0x%p len %d curlen %d\n",
 			__func__, i, destp, copy_len, curlen);
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,4,0))
 		srcp = kmap_atomic(ppages[i]);
+#else
+		srcp = kmap_atomic(ppages[i], KM_SKB_SUNRPC_DATA);
+#endif
 		memcpy(destp, srcp+page_base, curlen);
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,4,0))
 		kunmap_atomic(srcp);
+#else
+		kunmap_atomic(srcp, KM_SKB_SUNRPC_DATA);
+#endif
 		rqst->rq_svec[0].iov_len += curlen;
 		destp += curlen;
 		copy_len -= curlen;
@@ -639,10 +647,18 @@ rpcrdma_inline_fixup(struct rpc_rqst *rqst, char *srcp, int copy_len, int pad)
 			dprintk("RPC:       %s: page %d"
 				" srcp 0x%p len %d curlen %d\n",
 				__func__, i, srcp, copy_len, curlen);
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,4,0))
 			destp = kmap_atomic(ppages[i]);
+#else
+			destp = kmap_atomic(ppages[i], KM_SKB_SUNRPC_DATA);
+#endif
 			memcpy(destp + page_base, srcp, curlen);
 			flush_dcache_page(ppages[i]);
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,4,0))
 			kunmap_atomic(destp);
+#else
+			kunmap_atomic(destp, KM_SKB_SUNRPC_DATA);
+#endif
 			srcp += curlen;
 			copy_len -= curlen;
 			if (copy_len == 0)
diff --git a/net/sunrpc/xprtrdma/svc_rdma_transport.c b/net/sunrpc/xprtrdma/svc_rdma_transport.c
index 73b428b..325e9fd 100644
--- a/net/sunrpc/xprtrdma/svc_rdma_transport.c
+++ b/net/sunrpc/xprtrdma/svc_rdma_transport.c
@@ -445,7 +445,11 @@ static struct svcxprt_rdma *rdma_create_xprt(struct svc_serv *serv,
 
 	if (!cma_xprt)
 		return NULL;
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,3,0))
 	svc_xprt_init(&init_net, &svc_rdma_class, &cma_xprt->sc_xprt, serv);
+#else
+	svc_xprt_init(&svc_rdma_class, &cma_xprt->sc_xprt, serv);
+#endif
 	INIT_LIST_HEAD(&cma_xprt->sc_accept_q);
 	INIT_LIST_HEAD(&cma_xprt->sc_dto_q);
 	INIT_LIST_HEAD(&cma_xprt->sc_rq_dto_q);
diff --git a/net/sunrpc/xprtrdma/transport.c b/net/sunrpc/xprtrdma/transport.c
index b446e10..9419f34 100644
--- a/net/sunrpc/xprtrdma/transport.c
+++ b/net/sunrpc/xprtrdma/transport.c
@@ -283,7 +283,9 @@ xprt_setup_rdma(struct xprt_create *args)
 	}
 
 	xprt = xprt_alloc(args->net, sizeof(struct rpcrdma_xprt),
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,1,0) || CONFIG_COMPAT_XPRTRDMA_NEEDED)
 			xprt_rdma_slot_table_entries,
+#endif
 			xprt_rdma_slot_table_entries);
 	if (xprt == NULL) {
 		dprintk("RPC:       %s: couldn't allocate rpcrdma_xprt\n",
@@ -453,8 +455,14 @@ xprt_rdma_connect(struct rpc_task *task)
 }
 
 static int
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,1,0) || CONFIG_COMPAT_XPRTRDMA_NEEDED)
 xprt_rdma_reserve_xprt(struct rpc_xprt *xprt, struct rpc_task *task)
 {
+#else
+xprt_rdma_reserve_xprt(struct rpc_task *task)
+{
+	struct rpc_xprt *xprt = task->tk_xprt;
+#endif
 	struct rpcrdma_xprt *r_xprt = rpcx_to_rdmax(xprt);
 	int credits = atomic_read(&r_xprt->rx_buf.rb_credits);
 
@@ -466,7 +474,11 @@ xprt_rdma_reserve_xprt(struct rpc_xprt *xprt, struct rpc_task *task)
 		BUG_ON(r_xprt->rx_buf.rb_cwndscale <= 0);
 	}
 	xprt->cwnd = credits * r_xprt->rx_buf.rb_cwndscale;
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3,1,0) || CONFIG_COMPAT_XPRTRDMA_NEEDED)
 	return xprt_reserve_xprt_cong(xprt, task);
+#else
+	return xprt_reserve_xprt_cong(task);
+#endif
 }
 
 /*
-- 
1.7.9.5

